---
title: "imu_object"
output: rmarkdown::html_vignette
runtime: shiny
description:
  Learn how to use `imu_object()` to animate on shiny an inertial measurement 
  unit (IMU) connected to a serial port in real time 
vignette: >
  %\VignetteIndexEntry{imu_object}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction

This vignette describes a way to visualize on shiny a 3D animation of an inertial measurement unit (IMU) in real time. The setup requires:

* An IMU that is connected to the shiny server via a serial port (e.g. "COM3")
* Firmware that has been installed to write IMU measurements to a serial port. Each measurement is formatted as six comma-separated floats: acc_x, acc_y, acc_z, gyr_x, gyr_y, gyr_z. The required firmware is, of course, hardware dependent.

The core of the shiny logic consists of three parts:

* Read IMU data from a serial port and package it as inputs for `compUpdate()`
* Call `compUpdate()` to output a quaternion that represents the new orientation
* Call `imu_proxy()` and `imu_send_data()` to update the `imu_object()` widget with the quaternion

## IMU Data



```{r setup, message = FALSE}
library(imuf)
library(shiny)
library(serial)

getCon <- function(port) {
  #
  # set up connection for serial port
  con <- serial::serialConnection(name = "testcon", port = port,
                                  mode = "115200,n,8,1", newline = 1, translation = "crlf"
  )
  if (serial::isOpen(con)) {
    close(con)
  }
  con
}

readFromSerial <- function(con) {
  #
  # helper - function to convert sensor coord to NED
  bmi2ned <- function(bmi) {
    # convert bmi coord to ned coord
    c(bmi[1], -bmi[2], -bmi[3])
  }
  #
  # helper - function to convert deg to radian
  toRad <- function(deg) {
    deg * pi/180
  }
  #
  # functions to process and validate data read from serial port
  isValidLength <- function(x) {
    minLength <- 32
    if (x <= minLength) return(FALSE)
    return(TRUE)
  }
  str2Vec <- function(x) {
    #
    # data from the IMU is a row of 6 comma-separated floats:
    # accx, accy, accz, gyrx, gyry, gyrz
    y <- stringr::str_split_1(x, ",") %>%
      trimws() %>%
      as.numeric() %>%
      suppressWarnings()
    y
  }
  isValidNumElements <- function(x) {
    if (length(x) != 6) return(FALSE)
    return(TRUE)
  }

  while (TRUE) {
    nInQ <- serial::nBytesInQueue(con)["n_in"]
    if(!isValidLength(nInQ)) next
    #
    a <- serial::read.serialConnection(con) %>% str2Vec()
    if(!isValidNumElements(a)) next
    #
    # a is the IMU output we want, exit infinite loop
    break
  }
  # gyr from bmi270 IMU is in deg/sec, need to convert to rad/sec
  list(acc = bmi2ned(a[1:3]),
       gyr = bmi2ned(a[4:6]) %>% toRad())
}
```
